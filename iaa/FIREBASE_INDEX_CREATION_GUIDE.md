# Firestore インデックス作成ガイド

## 🚨 緊急対応

現在、以下のエラーが発生しています：

```
FirebaseError: [code=failed-precondition]: The query requires an index.
```

## 📋 解決手順

### 1. インデックス作成リンクをクリック

以下のリンクをクリックしてインデックスを作成してください：

**👉 [インデックス作成リンク](https://console.firebase.google.com/v1/r/project/iaa-airoutine/firestore/indexes?create_composite=Cktwcm9qZWN0cy9pYWEtYWlyb3V0aW5lL2RhdGFiYXNlcy8oZGVmYXVsdCkvY29sbGVjdGlvbkdyb3Vwcy9nb2Fscy9pbmRleGVzL18QARoKCgZ1c2VySWQQARoNCgljcmVhdGVkQXQQAhoMCghfX25hbWVfXxAC)**

### 2. Firebase Consoleでの操作

1. リンクをクリックすると、Firebase Consoleが開きます
2. 「インデックスを作成」ボタンをクリック
3. インデックスの作成が開始されます
4. 作成完了まで数分から数時間かかる場合があります

### 3. 作成されるインデックス

以下のインデックスが作成されます：

- **コレクション**: `goals`
- **フィールド**:
  - `userId` (昇順)
  - `createdAt` (降順)
- **クエリスコープ**: コレクション

## 🔧 一時的な回避策

インデックス作成が完了するまでの間、以下の回避策を実装しました：

### 現在の状態
- インデックスが必要な複合クエリを一時的に無効化
- シンプルなクエリ（`userId`のみ）を使用
- クライアント側でデータの並び替えを実行

### インデックス作成後の対応

インデックス作成が完了したら、以下の手順で元のクエリを有効化してください：

1. `src/lib/firestore.ts`の`subscribeToUserGoals`関数を開く
2. コメントアウトされた部分（149-166行目）のコメントを解除
3. 一時的な回避策（168-190行目）をコメントアウト
4. アプリケーションを再読み込み

## 📊 インデックス作成の確認

### Firebase Consoleでの確認方法

1. [Firebase Console](https://console.firebase.google.com/)にアクセス
2. プロジェクト「iaa-airoutine」を選択
3. 「Firestore Database」をクリック
4. 「インデックス」タブを選択
5. 作成されたインデックスを確認

### インデックス作成完了の確認

- **状態**: 「構築中」→「有効」
- **作成日時**: インデックス作成の完了時刻
- **フィールド**: `userId`, `createdAt`

## 🚀 インデックス作成後の動作

### 期待される動作

1. **エラー解消**: Firestoreエラーが表示されなくなります
2. **パフォーマンス向上**: サーバー側で並び替えが実行されます
3. **リアルタイム更新**: 目標データの変更がリアルタイムで反映されます

### テスト手順

1. アプリケーションを再読み込み
2. ログイン機能をテスト
3. 目標の作成・編集・削除をテスト
4. リアルタイム更新が正常に動作することを確認

## ⚠️ 注意事項

### インデックス作成中の注意

- **作成時間**: データ量によって数分から数時間かかる場合があります
- **エラー継続**: 作成中は引き続きエラーが発生します
- **一時的回避策**: 現在の回避策により基本的な機能は動作します

### パフォーマンス考慮

- **読み取り回数**: インデックス作成後も読み取り回数は変わりません
- **書き込みパフォーマンス**: 複合インデックスにより書き込みが若干遅くなる場合があります
- **ストレージ**: インデックス用のストレージコストが発生します

## 🔍 トラブルシューティング

### よくある問題

1. **インデックス作成に時間がかかる**
   - 大量のデータがある場合、作成に時間がかかります
   - Firebase Consoleで作成状況を確認してください

2. **リンクが開かない**
   - ブラウザのポップアップブロックを無効化してください
   - 別のブラウザで試してください

3. **まだエラーが発生する**
   - インデックス作成が完了していない可能性があります
   - Firebase Consoleでインデックス状況を確認してください

### サポート

問題が解決しない場合は、以下を確認してください：

1. Firebase Consoleのインデックス状況
2. ブラウザの開発者ツールでのエラーメッセージ
3. ネットワーク接続状況

## 📝 まとめ

1. **即座に**: インデックス作成リンクをクリック
2. **待機**: インデックス作成完了まで待機
3. **確認**: Firebase Consoleで作成状況を確認
4. **テスト**: アプリケーションの動作をテスト

これで、Firestoreの複合クエリが正常に動作するようになります！
